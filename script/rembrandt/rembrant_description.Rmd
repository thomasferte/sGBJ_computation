---
title: "Rembrant"
author: "TF"
output: 
  bookdown::html_document2:
    toc: yes
    toc_float: true
    number_sections: FALSE
    fig_caption: TRUE
    table_caption: TRUE
---


```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{r setup, include=FALSE, eval=TRUE,message=FALSE,warning=FALSE,cache=FALSE}

library(dplyr)
library(ggplot2)
library(survival)

datas_tot=readRDS(here::here("data/rembrandt/dfGenesAndClinical.rds"))

```


```{r dm}
##### Datamanagement

datas_filtered <- datas_tot |> 
  filter(DISEASE_TYPE %in% c("ASTROCYTOMA", "OLIGODENDROGLIOMA"),
         !is.na(OVERALL_SURVIVAL_MONTHS),
         !is.na(EVENT_OS),
         GENDER != "",
         AGE_RANGE != "") |> 
  select(-c(SUBJECT_ID,
            COPY_NUMBER,
            GENE_EXP,
            PARENT_ID,
            TYPE,
            TIMEPOINT,
            WHO_GRADE,
            RACE,
            INSTITUTION_NAME,
            KARNOFSKY,
            NEURO_EXAM_SCORE,
            DISEASE_EVAL_MRI,
            STEROID_DOSE_STATUS,
            ANTI_CONVULSANT_STATUS,
            starts_with("PRIOR_THERAPY_"),
            starts_with("ON_THERAPY"),
            starts_with("PT_NAME"))) |> 
  mutate(GENDER = as.factor(GENDER),
         AGE_RANGE = as.factor(AGE_RANGE),
         AGE_RANGE = forcats::fct_collapse(AGE_RANGE,
                                           "< 40" = c("15-19","20-24",
                                                      "25-29", "30-34",
                                                      "35-39"),
                                           ">= 40" = c("40-44","45-49",
                                                       "50-54","55-59",
                                                       "60-64","65-69",
                                                       "70-74","75-79",
                                                       "80-84","85-89"))) |> 
  sjlabelled::var_labels(AGE_RANGE = "Age",
                         GENDER = "Sex",
                         EVENT_OS = "Recurrence",
                         OVERALL_SURVIVAL_MONTHS = "Follow-up period in months",
                         DISEASE_TYPE = "Tumor type")
```

```{r desc}
##### Description
datas_filtered |> 
  dplyr::select(AGE_RANGE,
                GENDER,
                EVENT_OS,
                OVERALL_SURVIVAL_MONTHS,
                DISEASE_TYPE) |> 
  gtsummary::tbl_summary(by = DISEASE_TYPE)
```

```{r genecount, fig.cap="Rembrandt count per patient per tumor type"}
datas_filtered |> 
  dplyr::select(-c(AGE_RANGE,
                   GENDER,
                   EVENT_OS,
                   OVERALL_SURVIVAL_MONTHS)) |> 
  tidyr::pivot_longer(cols = -c(BIOSPECIMEN_ID, DISEASE_TYPE)) |> 
  ggplot(mapping = aes(x = BIOSPECIMEN_ID, y = value, fill = DISEASE_TYPE)) +
  geom_boxplot(outlier.shape = NA,lwd=0.1, alpha=1) +
  facet_wrap(.~DISEASE_TYPE, scales = "free_x") +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "none")+
  labs(x = "patients",
       y = "counts")

```

```{r rembrandtpca, fig.cap="First two PCA factorial plans"}
pca_model <- datas_filtered |> 
  dplyr::select(-c(BIOSPECIMEN_ID,
                   DISEASE_TYPE,
                   AGE_RANGE,
                   GENDER,
                   EVENT_OS,
                   OVERALL_SURVIVAL_MONTHS)) |> 
  FactoMineR::PCA(ncp = 4, graph = FALSE)

pca_coord <- pca_model$ind$coord |> 
  as.data.frame() |> 
  mutate(BIOSPECIMEN_ID = datas_filtered$BIOSPECIMEN_ID,
         DISEASE_TYPE = datas_filtered$DISEASE_TYPE,
         .before = 1)

p1 <- plot(pca_model, choix = "ind", axes = c(1, 2))
p2 <- plot(pca_model, choix = "ind", axes = c(3, 4))

ggpubr::ggarrange(p1, p2, common.legend = TRUE)
```

Here are the kaplan meier curves for the two types of disease: 

```{r kmrembrandt, fig.cap="Kaplan meier curves for Astro, Oligo"}
fit <- survfit(Surv(time=OVERALL_SURVIVAL_MONTHS, event=EVENT_OS) ~ DISEASE_TYPE,
               data = datas_filtered)


p_type=survminer::ggsurvplot(fit,
                             data = datas_filtered,
                             surv.median.line = "hv", # Add medians survival
                             
                             palette = c("#8338EC", "#FFB703"),
                             
                             # Change legends: title & labels
                             legend.title = "Type",
                             legend.labs = c("Astrocytoma", "Oligodendroglioma"),
                             
                             conf.int = TRUE,
                             # Add risk table
                             risk.table = TRUE,
                             tables.height = 0.2,
                             tables.theme = survminer::theme_cleantable(),
                             
                             title="Type of disease",
                             ggtheme = theme_bw() # Change ggplot2 theme
)
p_type

```


