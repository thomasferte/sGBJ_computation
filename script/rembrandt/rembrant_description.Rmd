---
title: "Rembrant"
author: "TF"
output: 
  bookdown::html_document2:
    toc: yes
    toc_float: true
    number_sections: FALSE
    fig_caption: TRUE
    table_caption: TRUE
---


```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{r setup, results='hide'}

library(dplyr)
library(ggplot2)
library(survival)

lapply(list.files(path = here::here("functions"), full.names = TRUE), source)

df_rembrandt <- fct_load_clean_rembrandt()

```

# Describe Rembrandt cohort

```{r desc}
##### Description
df_rembrandt |> 
  dplyr::select(AGE_RANGE,
                GENDER,
                EVENT_OS,
                OVERALL_SURVIVAL_MONTHS,
                DISEASE_TYPE) |> 
  gtsummary::tbl_summary(by = DISEASE_TYPE)
```

```{r genecount, fig.cap="Rembrandt count per patient per tumor type"}
df_rembrandt |> 
  dplyr::select(-c(AGE_RANGE,
                   GENDER,
                   EVENT_OS,
                   OVERALL_SURVIVAL_MONTHS)) |> 
  tidyr::pivot_longer(cols = -c(BIOSPECIMEN_ID, DISEASE_TYPE)) |> 
  ggplot(mapping = aes(x = BIOSPECIMEN_ID, y = value, fill = DISEASE_TYPE)) +
  geom_boxplot(outlier.shape = NA,lwd=0.1, alpha=1) +
  facet_wrap(.~DISEASE_TYPE, scales = "free_x") +
  theme_minimal() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "none")+
  labs(x = "patients",
       y = "counts")

```

```{r rembrandtpca, fig.cap="First two PCA factorial plans"}
pca_model <- df_rembrandt |> 
  dplyr::select(-c(BIOSPECIMEN_ID,
                   DISEASE_TYPE,
                   AGE_RANGE,
                   GENDER,
                   EVENT_OS,
                   OVERALL_SURVIVAL_MONTHS)) |> 
  FactoMineR::PCA(ncp = 4, graph = FALSE)

pca_coord <- pca_model$ind$coord |> 
  as.data.frame() |> 
  mutate(BIOSPECIMEN_ID = df_rembrandt$BIOSPECIMEN_ID,
         DISEASE_TYPE = df_rembrandt$DISEASE_TYPE,
         .before = 1)

p1 <- plot(pca_model, choix = "ind", axes = c(1, 2))
p2 <- plot(pca_model, choix = "ind", axes = c(3, 4))

ggpubr::ggarrange(p1, p2, common.legend = TRUE)
```

Here are the kaplan meier curves for the two types of disease: 

```{r kmrembrandt, fig.cap="Kaplan meier curves for Astro, Oligo"}
fit <- survfit(Surv(time=OVERALL_SURVIVAL_MONTHS, event=EVENT_OS) ~ DISEASE_TYPE,
               data = df_rembrandt)


p_type=survminer::ggsurvplot(fit,
                             data = df_rembrandt,
                             surv.median.line = "hv", # Add medians survival
                             
                             palette = c("#8338EC", "#FFB703"),
                             
                             # Change legends: title & labels
                             legend.title = "Type",
                             legend.labs = c("Astrocytoma", "Oligodendroglioma"),
                             
                             conf.int = TRUE,
                             # Add risk table
                             risk.table = TRUE,
                             tables.height = 0.2,
                             tables.theme = survminer::theme_cleantable(),
                             
                             title="Type of disease",
                             ggtheme = theme_bw() # Change ggplot2 theme
)
p_type

```
