---
title: "Gene Set Analysis for time-to-event outcome:comparison of a new approach based on the Generalized Berk–Jones statistic with existing methods in presence of intra gene-set correlation"
subtitle: "Supplementary"
author: ""
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    toc: True
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.pos = "H",
                      out.extra = "",
                      fig.prefix = "S")
```

```{r}
library(dplyr)
library(ggplot2)

source(file = here::here("functions/fct_report_simu_setting.R"))
load(here::here("reporting/master_draft/precomputed/precompute_plots.rdata"))


dfRembrandt <- readRDS(here::here("data/rembrandt/dfresvarcovar.rds"))
dfBreast <- readRDS(here::here("data/breast_cancer/dfresvarcovar.rds"))
```

# Simulation Settings from Real Data

This section aims to identify realistic simulation settings using the Rembrandt and Breast Cancer datasets.

## Proportion of Significant Genes

As shown in Figure \@ref(fig:propsigngenes), the proportion of significant genes is approximately 45% for the Rembrandt dataset and 20% for the Breast Cancer dataset.

```{r propsigngenes, fig.cap="Proportion of significant genes in each pathway for each data source.", fig.height=3, fig.width=4}
dplyr::bind_rows(dfRembrandt$dfCoxVariance |> mutate(data = "Rembrandt"),
                 dfBreast$dfCoxVariance |> mutate(data = "Breast")) |> 
  group_by(pathway, data) |> 
  summarise(nb_genes = n(),
            nb_sign_genes = sum(SIGN),
            prop_sign_genes = nb_sign_genes/nb_genes,
            .groups = "drop") |> 
  ggplot(mapping = aes(y = prop_sign_genes, x = data)) +
  geom_boxplot() +
  scale_y_continuous(breaks = seq(0, 1, by = .2)) +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(x = "Data source",
       y = "Proportion of significant genes")

```

## Gene expression variance

Gene expression variance was studied in each data source.
It was of approximately $0.3$ and $0.09$ in Rembrandt and Breast cancer data respectively.
For simulations, we use an intermediate variance of 0.2 (Figure \@ref(fig:genevariance)).

```{r genevariance, fig.cap="Gene expression variance for each data source.", fig.height=3, fig.width=4}
dplyr::bind_rows(dfRembrandt$dfCoxVariance |> mutate(data = "Rembrandt"),
                 dfBreast$dfCoxVariance |> mutate(data = "Breast")) |> 
  select(data, GENE, VARIANCE) |> 
  distinct() |> 
  ggplot(mapping = aes(y = VARIANCE, x = data)) +
  geom_boxplot() +
  scale_y_log10(guide = "axis_logticks") +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(x = "Data source",
       y = "Gene Expression Variance")

```

## Gene expression correlation

Gene expression correlation was evaluated on each pathway of each data source.
Correlation was evaluated overall and stratified by gene significance.
Figure \@ref(fig:overallgenecorrelation) indicates that an overall gene correlation following a non-standard beta distribution(20, 20, min = -1, max = 1) is realistic for both Rembrandt and Breast cancer data. This is denoted as case I.
When stratified by gene significance, figure \@ref(fig:genecorrelationbysign) outlines that a non-standard beta distribution(10, 10, min = -1, max = 1) for significant genes and non-standard beta distribution(25, 25, min = -1, max = 1) for non-significant genes is realistic. This is denoted as case II.

A simpler simulation setting considering 0.2 correlation between significant genes and 0 correlation between non-significant genes was also considered.

```{r overallgenecorrelation, fig.cap="Gene expression correlation for each pathway in each data source.", fig.height=3}
ls_R <- fct_plot_correlation(dfRembrandt, caption = "Rembrandt : Shapes of non-standard beta distribution by type of gene")
ls_B <- fct_plot_correlation(dfBreast, caption = "Breast : Shapes of non-standard beta distribution by type of gene")

plot_R <- ls_R$plot_unique + ggtitle("Rembrandt")
plot_B <- ls_B$plot_unique + ggtitle("Breast")

ggpubr::ggarrange(plot_R, plot_B)
```

```{r genecorrelationbysign, fig.cap="Gene expression correlation for each pathway in each data source stratified by gene significance.", fig.height=5}
plot_R <- ls_R$plot_multiple + ggtitle("Rembrandt")
plot_B <- ls_B$plot_multiple + ggtitle("Breast")

ggpubr::ggarrange(plot_R, plot_B)
```

## Beta from Cox model

```{r}
lsbeta_R <- fct_beta_dist(dfRembrandt, caption = "Rembrandt : Proportion of positive, negative and non significant genes")
lsbeta_B <- fct_beta_dist(dfBreast, caption = "Breast cancer : Proportion of positive, negative and non significant genes")
```

Beta coefficient distributions, both overall and stratified by gene significance, were examined in the two datasets.
Figure \@ref(fig:betacoef) indicates that the overall distribution of effect sizes is well approximated by a normal distribution with mean 0 and standard deviation 0.4; we refer to this setting as Type A.
Figure \@ref(fig:betacoefstrat) further shows that, in the Rembrandt dataset, half of the gene effects follow a normal distribution with mean -0.4 and standard deviation 0.2, while the other half follow a normal distribution with mean 0.4 and standard deviation 0.2; we denote this as Type B.
In contrast, the Breast Cancer dataset is characterized by a wider separation, with half of the effects following a normal distribution with mean -0.8 and standard deviation 0.4, and the other half following a normal distribution with mean 0.8 and standard deviation 0.4; this is referred to as Type C.

```{r betacoef, fig.cap="Beta coefficient distribution for each data source.", fig.height=3}
plot_R <- lsbeta_R$plot_unique_beta + ggtitle("Rembrandt")
plot_B <- lsbeta_B$plot_unique_beta + ggtitle("Breast")

ggpubr::ggarrange(plot_R, plot_B)
```

```{r betacoefstrat, fig.cap="Beta coefficient distribution for each data source stratified by gene significance.", fig.height=5}
plot_R <- lsbeta_R$plot_multiple_beta + ggtitle("Rembrandt")
plot_B <- lsbeta_B$plot_multiple_beta + ggtitle("Breast")

ggpubr::ggarrange(plot_R, plot_B)
```

<!-- # Pathway overlap -->

<!-- ```{r} -->
<!-- vec_best_genes_rembrandt <- c() -->
<!-- vec_pathway_covered_rembrandt <- c() -->
<!-- vec_nb_pathway_covered_rembrandt <- c() -->

<!-- for(i in 1:7){ -->
<!--   best_gene_rembrandt <- dfRembrandt$dfCoxVariance |>  -->
<!--     filter(!pathway %in% vec_pathway_covered_rembrandt, SIGN) |>  -->
<!--     group_by(GENE) |>  -->
<!--     summarise(nb_pathway = length(unique(pathway))) |>  -->
<!--     slice_max(nb_pathway) |>  -->
<!--     pull(GENE) -->

<!--   vec_best_genes_rembrandt <- c(vec_best_genes_rembrandt, best_gene_rembrandt[1]) -->

<!--   vec_pathway_covered_rembrandt <- dfRembrandt$dfCoxVariance |>  -->
<!--     filter(GENE %in% vec_best_genes_rembrandt) |>  -->
<!--     pull(pathway) |>  -->
<!--     unique() -->

<!--   vec_nb_pathway_covered_rembrandt <- c(vec_nb_pathway_covered_rembrandt, length(vec_pathway_covered_rembrandt)) -->
<!-- } -->
<!-- ``` -->

<!-- ```{r} -->
<!-- vec_best_genes_breast <- c() -->
<!-- vec_pathway_covered_breast <- c() -->
<!-- vec_nb_pathway_covered_breast <- c() -->

<!-- dfBreast$dfCoxVariance$pathway |> unique() |> length() -->

<!-- for(i in 1:15){ -->
<!--   best_gene_breast <- dfBreast$dfCoxVariance |>  -->
<!--     filter(!pathway %in% vec_pathway_covered_breast, SIGN) |>  -->
<!--     group_by(GENE) |>  -->
<!--     summarise(nb_pathway = length(unique(pathway))) |>  -->
<!--     slice_max(nb_pathway) |>  -->
<!--     pull(GENE) -->

<!--   vec_best_genes_breast <- c(vec_best_genes_breast, best_gene_breast[1]) -->

<!--   vec_pathway_covered_breast <- dfBreast$dfCoxVariance |>  -->
<!--     filter(GENE %in% vec_best_genes_breast) |>  -->
<!--     pull(pathway) |>  -->
<!--     unique() -->

<!--   vec_nb_pathway_covered_breast <- c(vec_nb_pathway_covered_breast, length(vec_pathway_covered_breast)) -->
<!-- } -->
<!-- ``` -->


# QQ-plot main analysis

Figure \@ref(fig:figqqplot) presents quantile–quantile (QQ) plots of the p-values obtained with the different methods, compared to the uniform distribution. The results indicate that the Harmonic Mean and Cauchy methods tend to under-control the Type I error, whereas sGBJ is overly conservative. Notably, sGBJ exhibits an unexpectedly large number of p-values close to 1 compared with the theoretical distribution; however, this behavior is consistent with its conservative nature and reflects an excess of non-significant p-values.

```{r figqqplot, fig.height=6, fig.cap="Quantile–quantile (QQ) plots of p-values for the different methods under the null hypothesis, compared with the uniform distribution. Well-calibrated methods are expected to align with the 45-degree diagonal."}
plot_alpha_qqplot
ggsave(plot_alpha_qqplot,
       filename = here::here("reporting/master_draft/figures/plot_alpha_qqplot.pdf"),
       device = cairo_pdf,
       height = 6,
       width = 6)
```


# Sensitivity Analysis

## High correlation setting

Figure \@ref(fig:figcaseiv) presents Case IV, in which significant genes are correlated with each other with a correlation of 0.9. Panel A shows that power is very similar across the different methods, except for the Global Boost Test, which exhibits a decrease in power. Panel B shows a similar failure of Type I error control for the Harmonic Mean and Cauchy methods as observed elsewhere in the paper.

```{r figcaseiv, fig.height=6, fig.cap="Panel A shows the statistical power of the different methods in Case IV, Type A. Panel B shows p-values for each method compared with the uniform distribution under the Type-Z (no association) setting; well-calibrated methods align with the 45-degree diagonal."}
plot_simulation_case_IV
ggsave(plot_simulation_case_IV,
       filename = here::here("reporting/master_draft/figures/plot_simulation_case_IV.pdf"),
       device = cairo_pdf,
       height = 6,
       width = 6)
```

## Varying proportion of significant genes

Figure \@ref(fig:figpropsign) shows the behavior of the different methods as the proportion of significant genes varies. The results indicate that the conservative Type I error correction of sGBJ has a stronger impact as the proportion of significant genes decreases. The other methods exhibit similar performance. The Cauchy and Harmonic Mean methods still fail to control the Type I error.

```{r figpropsign, fig.height=6, fig.cap="Panel A shows the statistical power of the different methods in Case III, Type A with various proportion of significiant genes. Panel B shows p-values for each method compared with the uniform distribution under the Case III, Type-Z (no association) setting; well-calibrated methods align with the 45-degree diagonal."}
plot_simulation_prop_sign
ggsave(plot_simulation_prop_sign,
       filename = here::here("reporting/master_draft/figures/plot_simulation_prop_sign.pdf"),
       device = cairo_pdf,
       height = 6,
       width = 6)
```

## Large number of observations

Figure \@ref(fig:figthousands) illustrates the behavior of the different methods as the number of observations increases up to 1,000. The results indicate that the conservative Type I error correction of sGBJ becomes less problematic when the number of observations is large relative to the number of genes. This suggests that the limitation of sGBJ is primarily a dimensionality issue: the method does not perform well under a high p/n ratio, rather than being affected by the absolute number of genes. In contrast, the Cauchy and Harmonic Mean methods continue to fail to adequately control the Type I error.

```{r figthousands, fig.height=8, fig.cap="Panel A displays the statistical power of the different methods in Case I, Type A, as the number of observations increases from 50 to 1,000. Panel B shows the corresponding Type I error rates for the different methods, with a nominal target level of 0.05. Panel C presents quantile–quantile plots of p-values for each method under the Case III, Type Z (no association) setting; well-calibrated methods follow the 45-degree diagonal."}
plot_simulation_1000
ggsave(plot_simulation_1000,
       filename = here::here("reporting/master_draft/figures/plot_simulation_1000.pdf"),
       device = cairo_pdf,
       height = 7,
       width = 8.5)
```

# Estimation of covariance matrix by sGBJ

Figure \@ref(fig:figfrobenius) shows the Frobenius distance between the true gene-effect covariance matrix and the matrix estimated by sGBJ for Case (I), Type B. The results indicate a substantial improvement in covariance estimation when the number of permutations increases from 8 to 200. Increasing the number of permutations further to 1,000 and 5,000 yields little additional improvement. These conclusions hold regardless of the number of genes or observations.

```{r figfrobenius, fig.height=5, fig.cap="Frobenius distance between the true and sGBJ-estimated gene effect covariance matrices as a function of the number of observations, number of genes, and number of sGBJ permutations. Experiment on Case (I), Type : B."}
dfFrobenius <- readRDS(file = here::here("data/frobenius"))

labs_nb_genes = paste0("Nb of genes : ", c(10, 50, 100))
names(labs_nb_genes) <- c(10, 50, 100)

ggplot(dfFrobenius |> 
         mutate(nb_observations = as.factor(nb_observations)),
       mapping = aes(x = nperm_sGBJ, y = frobenius, color = nb_observations, group = interaction(nb_observations, nperm_sGBJ))) +
  geom_boxplot() +
  facet_grid(nb_genes ~ ., scales = "free_y", labeller = labeller(nb_genes = labs_nb_genes)) +
  scale_x_log10(breaks = c(8, 40, 200, 1000, 5000)) +
  annotation_logticks(sides = "bottom") +
  scale_color_manual(values = c("grey", "black")) +
  theme_bw() +
  labs(x = "Number of permutations (sGBJ)",
       y = "Frobenius distance",
       color = "Number of observations")

```

